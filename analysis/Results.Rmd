---
title: "Results"
author: "Remo Schmutz"
date: "2024-05-01"
output:
  html_document: 
    fig_caption: true
    code_folding: hide
    highlight: tango
    theme: simplex
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}
library(wesanderson)
library(rnaturalearth)
library(sf)
library(readxl)
library(janitor)
library(paletteer)
library(maps)
library(table1)
library(ggpubr)
library(kableExtra)
library(scales)
library(showtext)
library(jtools)
library(lme4)
library(brglm2)
library(gtsummary)
library(gt)
library(scico)
library(cowplot)
library(MASS)
library(tidyverse)


source("../utils/plots.R")
                                      
df <- readRDS("../data_clean/data_clean.rds") %>% 
  filter(tpt_prov == 1)

df_no_TPT <- readRDS("../data_clean/data_clean.rds") %>% 
  filter(tpt_prov == 0)
```

-   The complete dataset includes 235 observations

    -   excluding region North America there are 201 observations left

    -   excluding incomplete responses there are 199 observations left

    -   excluding high income countries there are 178 observations left

    -   excluding sites that do not offer TPT there are 172 observations left

# Data overview

```{r}
df %>%
  select(country, Prev_cat.factor, Income_group) %>% 
  group_by(country) %>%
  summarise(
    `Number of sites` = n(),
    `HIV Prevalence` = first(Prev_cat.factor),  # Assumes all entries are the same per country
    `Income Group` = first(Income_group)  # Assumes all entries are the same per country
  ) %>%
  ungroup() %>% 
  kable() %>% 
  kable_styling(full_width = T)
```

# Site characteristic of the excluded sites

We excluded six sites from our analysis because they do not offer TPT at the time of the survey.

```{r}
country_lookup <- tibble::tribble(
  ~country_code, ~country_name,
  "IND", "India",
  "ZAF", "South Africa",
  "UGA", "Uganda",
  "KEN", "Kenya",
  "TGO", "Togo"
  # Add other country codes and names as needed
)

df_no_TPT <- df_no_TPT %>%
  left_join(country_lookup, by = c("country" = "country_code")) %>%
  select(country_name, name, region, Prev_cat.factor, Income_group, level.factor, tbhiv_integration.factor) %>%
  rename(Country = country_name,
         Name = name, 
         Region = region,
         `HIV Prevalence` = Prev_cat.factor,
         `Income Level` = Income_group,
         `Facility level of care` = level.factor,
         `Level of Integration` = tbhiv_integration.factor) %>% 
  arrange(Country)
# Create the table using gt

df_no_TPT %>%
  gt() %>%
  cols_label(
    Country = "Country",
    Name = "Name",
    Region = "Region",
    `HIV Prevalence` = "HIV Prevalence",
    `Income Level` = "Income Level",
    `Facility level of care` = "Facility level of care",
    `Level of Integration` = "Level of Integration"
  ) %>%
  tab_options(
    table.width = pct(100)) |>
  gt::gtsave(filename = "../results/tbl_excluded.docx")
```

# Figure 1

Identifying populations for latent TB infection (LTBI) testing and TB preventive treatment after exclusion of active TB. Mapping according to WHO guidelines (see WHO consolidated guidelines, Table 1, page xi). Household contacts are defined as household contacts of people with bacteriologically confirmed pulmonary TB, regardless of HIV status. These three groups are not exclusive, there can be overlap. PLHIV can also be household contacts.

```{r}
dt <- df %>%
  select(record_id, region, tpt_eligible_adult___77:tpt_eligible_adult___88) %>%
  rename("None" = tpt_eligible_adult___77,
         'Antiretroviral status' = tpt_eligible_adult___1,
         'Pregnancy status' = tpt_eligible_adult___2,
         'Prior TB treatment' = tpt_eligible_adult___3,
         'Degree of immunosuppression' = tpt_eligible_adult___4,
         'Contact with TB patient' = tpt_eligible_adult___5,
         'Latent TB infection status' = tpt_eligible_adult___6,
         'Other' = tpt_eligible_adult___88) %>%
  mutate(across(everything(), as.character)) %>%  # Convert all columns to character
  pivot_longer(names_to = "Question", values_to = "Response", cols = -c(record_id, region))

dt %>% ggplot(aes(y = Question, fill = Response)) +
  geom_bar(position = "fill")

dt %>% ggplot(aes(y = Question, fill = Response)) +
  geom_bar(position = "fill") +
  facet_wrap(~region)

dt %>% mutate(Response = as.numeric(Response)) %>% 
  filter(Response != "None") %>% 
  group_by(record_id) %>% 
  summarise(count = sum(Response)) %>% 
  ggplot(aes(x = count)) +
  geom_histogram(binwidth = .5) +  # Set binwidth to 1 for integer counts
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +  # Adjust the number of breaks
  theme_minimal() +  # Optional: change the theme
  labs(title = "Histogram of Count",
       x = "Count",
       y = "Frequency")

dt_none <- df %>%
  select(record_id, region, tpt_eligible_adult___77:tpt_eligible_adult___88) %>%
  rename("None" = tpt_eligible_adult___77,
         'Antiretroviral status' = tpt_eligible_adult___1,
         'Pregnancy status' = tpt_eligible_adult___2,
         'Prior TB treatment' = tpt_eligible_adult___3,
         'Degree of immunosuppression' = tpt_eligible_adult___4,
         'Contact with TB patient' = tpt_eligible_adult___5,
         'Latent TB infection status' = tpt_eligible_adult___6,
         'Other' = tpt_eligible_adult___88) %>%
  mutate(across(c(`Antiretroviral status`, `Pregnancy status`, `Prior TB treatment`,
                  `Degree of immunosuppression`, `Contact with TB patient`,
                  `Latent TB infection status`, `Other`), as.numeric)) %>%
  rowwise() %>%
  mutate(Any = if_else(any(c_across(`Antiretroviral status`:`Other`) == 1), 1, 0)) %>%
  ungroup() %>% select(record_id, None, Any) %>% summarise(sum1 = sum(None), sum2 = sum(Any))

```

```{r, fig.cap="Figure 1: Populations eligible for latent TB infection (LTBI) testing and TB preventive treatment after exclusion of active TB eligible for TPT. Mapping according to WHO guidelines."}

df1 <- df %>%
  select(
    record_id, region, tpt_eligible_adult___77:tpt_eligible_adult___88, tpt_lt12m, tpt_ge1y, tpt_g11y_tb, tpt_peds_lt5,
    tpt_peds_ge9, tpt_adults, tpt_hrcontacts, tpt_atrisk___3:tpt_atrisk___13, HBC_ANY, HBC_TB,
    HBC_TB_HIV, HBC_DR_TB, tbhiv_integration.factor, Income_group, Prev_cat.factor, ltbi_ligibility.factor)  %>% 
  mutate(
    across(
      c(tpt_lt12m, tpt_g11y_tb, tpt_peds_lt5, tpt_ge1y, tpt_peds_ge9, 
        tpt_adults,tpt_hrcontacts),
      ~ as.factor(if_else(is.na(.), "0", as.character(.)))), #manually checked - they dont provide TPT at all, so would be "No" but they had to skip the question
    across(
      c(tpt_peds_lt5, tpt_peds_ge9, tpt_adults, tpt_hrcontacts),
      ~ as.factor(if_else(. == "2", "0", .)))) %>% #"No" was coded as 2 here
  mutate(across(
      tpt_eligible_adult___77:tpt_eligible_adult___88,  # Ensure all selected columns are numeric
      ~ as.numeric(.)
    ),
    tpt_adult = tpt_eligible_adult___77) %>% 
  select(-c(tpt_eligible_adult___77:tpt_eligible_adult___88)) %>% 
  rename(
    'Children (< 5 years)' = tpt_peds_lt5,
    'Children (5-10 years)' = tpt_peds_ge9,
    'Adults & adolescents (>10 years)' = tpt_adults,
    'Contacts of MDR-TB Patients' = tpt_hrcontacts,
    'People on anti-TNF treatment' = tpt_atrisk___3,
    'People preparing for transplant' = tpt_atrisk___4,
    'People with silicosis' = tpt_atrisk___5,
    Prisoners = tpt_atrisk___6,
    'Health workers' = tpt_atrisk___7,
    'Immigrants (TB burden country)' = tpt_atrisk___8,
    Homeless = tpt_atrisk___9,
    'Drug users' = tpt_atrisk___10,
    'Alcohol users' = tpt_atrisk___11,
    'Tabacco users' = tpt_atrisk___12,
    'Underweight' = tpt_atrisk___13,
    'Adults & adolescents (>10 years) ' = tpt_adult, #add space to distingush it from the same variable in the other category
    'Infants (<12months, contact with person with TB)' = tpt_lt12m,
    'Children (1-9 years, high TB setting)' = tpt_ge1y,
    'Children (1-9 years, completed TB treatment)' = tpt_g11y_tb,
    'Level of integration' = tbhiv_integration.factor,
    'Income Level' = Income_group, 
    'HIV Prevalence' = Prev_cat.factor,
    'LTBI testing' = ltbi_ligibility.factor) %>% 
  mutate(across(
    .cols = everything(),
    .fns = ~ as.factor(as.character(.))))  %>% 
  pivot_longer(
    cols = 
      -c(record_id, region, HBC_ANY, HBC_TB, HBC_TB_HIV, HBC_DR_TB, `Level of integration`, `Income Level`, `HIV Prevalence`, `LTBI testing`),
    names_to = "variable",
    values_to = "category")  %>% 
  mutate(
    category = factor(category, levels = c("0", "1", "3", "77"), 
                      labels = c("No", "Yes", "Don't know", "Don't know")),
    who_group = factor(
      case_when(
        variable %in% c("Adults & adolescents (>10 years) ", #add a space to distinguish it from the same variable in the other category
                        "Infants (<12months, contact with person with TB)", 
                        "Children (1-9 years, high TB setting)", 
                        "Children (1-9 years, completed TB treatment)") ~ "People living with HIV",
        variable %in% c("Children (< 5 years)",
                        "Children (5-10 years)",
                        "Adults & adolescents (>10 years)",
                        "Contacts of MDR-TB Patients") ~ "Household contacts",
        variable %in% c("People on anti-TNF treatment",
                        "People preparing for transplant",
                        "Prisoners",
                        "People with silicosis",
                        "Health workers",
                        "Immigrants (TB burden country)",
                        "Homeless",
                        "Drug users",
                        "Alcohol users",
                        "Tabacco users",
                        "Underweight") ~ "Other people at risk", 
        TRUE ~ "Others"),
      levels = c("People living with HIV", "Household contacts", "Other people at risk")))

df1$`Level of integration` <- factor(df1$`Level of integration`,
                                     levels = c("No", "Partial", "Full"))

df1$`HIV Prevalence` <- factor(df1$`HIV Prevalence`, 
                               levels = c("Low (<1%)", "Middle (1-5%)", "High (>5%)"))

saveRDS(df1, "../data_clean/df1.rds")
```

```{r}
fig.1 <- fig1("", pct = T)
fig.1
ggsave("../results/fig1.png", plot = fig.1, width = 16, height = 12, units = "cm", dpi = 300)
```

### Stratified by high burden countries (all)

```{r}
fig1("HBC")
```

### Stratified by high burden countries (any vs. no)

```{r}
fig1("HBC_ANY")
```

### Stratified by region

```{r}
fig1("region")
```

### Stratified by level of integration

```{r}
fig1("Level of integration")
```

### Stratified by Income Level

```{r}
fig1("Income Level")
```

### Stratified by HIV Prevalence

```{r}
fig1("HIV Prevalence")
```

### Stratified by LTBI testing to check eligiblity for TPT for PLHIV

```{r}
fig1("LTBI testing")
```

### Panel

```{r, fig.height=15, fig.width=11, message=F, warning=F}

fig1a <- fig1("HBC_ANY") + theme(strip.text.y.right = element_blank(), 
                                 axis.title.x.bottom = element_blank()) + 
    scale_x_continuous(
      labels = function(x) paste0(format(x * 100, digits = 2), "%"),
      breaks = c(0, 1)) +
  labs(title = "a | Stratified by high TB burden countries")

fig1b <- fig1("region") + 
  theme(axis.text.y = element_blank(), 
        axis.title.x.bottom = element_blank()) +
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1))+
  labs(title = "b | Stratified by region")

fig1c <- fig1("Income Level") + 
  theme(strip.text.y.right = element_blank(), 
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1)) +
  labs(title = "c | Stratified by Income Level")

fig1d <- fig1("HIV Prevalence") + 
  theme(axis.text.y = element_blank(), 
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1))+
  labs(title = "d | Stratified by HIV Prevalence")

fig1e <- fig1("Level of integration") + 
  theme(strip.text.y.right = element_blank(),
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1)) +
  labs(title = "e | Stratified by Level of Integration")

fig1f <- fig1("LTBI testing")+
  theme(axis.text.y = element_blank(),
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1)) +
  labs(title = "f | Stratified by LTBI testing")
  

fig.1 <- ggarrange(fig1a, fig1b, fig1c, fig1d, fig1e,fig1f,
                 common.legend = TRUE, 
                 ncol = 2, nrow = 3,
                 legend = "bottom", 
                 widths = c(1.5, 1))
                 

fig.1
```

# Figure 2

Barriers to TPT administration: \*\*11.15 What are the most important barriers to initiating patients with HIV on TPT at this facility? Check all that apply\*\* Â 

```{r}
df2 <- df %>% 
  select(record_id, region, tpt_barriers___77:tpt_barriers___88, HBC_ANY, HBC_TB,
    HBC_TB_HIV, HBC_DR_TB, tbhiv_integration.factor, Income_group, Prev_cat.factor, ltbi_ligibility.factor) %>%
  rename(
         'No barriers' = tpt_barriers___77,
         'Medication availability' = tpt_barriers___1,
         'LTBI Testing stockouts' = tpt_barriers___2,
         'Availability of diagnostics active TB' = tpt_barriers___3,
         'Concerns drug resistance' = tpt_barriers___4,
         'Increased workload' = tpt_barriers___5,
         'Patients refuse TPT' = tpt_barriers___6,
         'Access to HIV care service delivery'= tpt_barriers___7,
         'Other barriers' = tpt_barriers___88,
         'Level of integration' = tbhiv_integration.factor,
         'Income Level' = Income_group, 
         'HIV Prevalence' = Prev_cat.factor,
         'LTBI testing' = ltbi_ligibility.factor) %>% 
  mutate(across(everything(), ~ as.factor(.))) %>% 
  pivot_longer(cols = -c(record_id, region, HBC_ANY, HBC_TB, HBC_TB_HIV, HBC_DR_TB, `Level of integration`, `Income Level`, `HIV Prevalence`, `LTBI testing`),
               names_to = "variable",
               values_to = "category") %>% 
  mutate(variable = as.factor(variable),
         category = as.factor(ifelse(category == 1, "Yes", "No"))) 

df2$`Level of integration` <- factor(df2$`Level of integration`,
                                     levels = c("No", "Partial", "Full"))

df2$`HIV Prevalence` <- factor(df2$`HIV Prevalence`, 
                               levels = c("Low (<1%)", "Middle (1-5%)", "High (>5%)"))
df2$variable <- factor(df2$variable,
                       levels = c("Other barriers", "Concerns drug resistance", "Medication availability", "LTBI Testing stockouts", "Increased workload","Availability of diagnostics active TB","Access to HIV care service delivery", "Patients refuse TPT", "No barriers"))

saveRDS(df2, "../data_clean/df2.rds")
```

```{r, fig.cap="Figure 2: Proportion of clinics responding to the questions regarding specific boundaries to initiating patients with HIV on TPT at the clinic. Also, if somebody in the clinic received formal training for TPT."}
fig.2 <- fig2("", pct = T)
fig.2
ggsave("../results/fig2.png", plot = fig.2, width = 16, height = 12, units = "cm", dpi = 300)
```

### Stratified by high burden countries

```{r}
fig2("HBC")
```

### Stratified by high burden countries (any vs. no)

```{r}
fig2("HBC_ANY")
```
### Stratified by region

```{r}
fig2("region")
```

### Stratified by level of integration

```{r}
fig2("Level of integration")
```

### Stratified by Income Level

```{r}
fig2("Income Level")
```

### Stratified by HIV Prevalence

```{r, warning=FALSE}
fig2("HIV Prevalence")
```

### Stratified by LTBI testing to check eligiblity for TPT for PLHIV

```{r}
fig2("LTBI testing")
```

### Panel

```{r, fig.height=15, fig.width=11, message=F, warning=F}
fig2a <- fig2("HBC_ANY") + theme(strip.text.y.right = element_blank(), 
                                 axis.title.x.bottom = element_blank()) +
    scale_x_continuous(
      labels = function(x) paste0(format(x * 100, digits = 2), "%"),
      breaks = c(0, 1)) +
  labs(title = "a | Stratified by high TB burden countries")
  

fig2b <- fig2("region") + theme(axis.text.y = element_blank(), 
                                axis.title.x.bottom = element_blank()) +  scale_x_continuous(
      labels = function(x) paste0(format(x * 100, digits = 2), "%"),
      breaks = c(0, 1))+
    labs(title = "b | Stratified by region")


fig2c <- fig2("Income Level") + theme(strip.text.y.right = element_blank(), 
                                      axis.title.x.bottom = element_blank()) +  scale_x_continuous(
      labels = function(x) paste0(format(x * 100, digits = 2), "%"),
      breaks = c(0, 1)) +
    labs(title = "c | Stratified by Income Level")


fig2d <- fig2("HIV Prevalence") + theme(axis.text.y = element_blank(), 
                                        axis.title.x.bottom = element_blank()) +  scale_x_continuous(
      labels = function(x) paste0(format(x * 100, digits = 2), "%"),
      breaks = c(0, 1)) +
    labs(title = "d | Stratified by HIV Prevalence")

fig2e <- fig2("Level of integration") + 
  theme( strip.text.y.right = element_blank(),
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1)) +
    labs(title = "e | Stratified by Level of Integration")

#fig2f <- fig2("LTBI testing") + 
  # theme( axis.text.y = element_blank(), 
  #       axis.title.x.bottom = element_blank()) +  
  # scale_x_continuous(
  #   labels = function(x) paste0(format(x * 100, digits = 2), "%"),
  #   breaks = c(0, 1))+
  #   labs(title = "f | Stratified by LTBI testing")

fig.2 <- ggarrange(fig2a, fig2b, fig2c, fig2d, fig2e, 
                 common.legend = TRUE, 
                 ncol = 2, nrow = 3,
                 legend = "bottom", 
                 widths = c(1.5, 1))
fig.2
ggsave("../results/fig2.png", plot = fig.2, width = 16, units = "cm")
```

# Figure 3

-   Proportion of sites who responded "Yes" to the following question: "11.6 Does this HIV clinic (or a co-located TB clinic) currently provide TB preventive therapy (TPT)?".

-   The points are located at the coordinates from the sites (from Google Maps).

-   (a) Location of sites, Adherence to any recommendation for (b) PLHIV, (c) other people at risk and (d) other people at risk.

```{r}
#theme
plain <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  panel.background = element_rect(fill = "white"),
  plot.title = element_text(hjust = 0.5))

#preperation

coords <- read.csv("../data_clean/coordinates_sites.csv") %>%
  separate(coord, into = c("lat", "long"), sep = ",", convert = TRUE) %>% 
  filter(record_id %in% df$record_id)

world <- map_data("world") 

df3 <- df1 %>% 
  group_by(record_id, who_group) %>% 
  dplyr::summarize(any_yes = ifelse(any(category == "Yes"), 1, 0), .groups = 'drop')  %>% 
  left_join(df %>% select(record_id, region_exact), by = "record_id") 

## household ##

fig3a <- fig3(variable = "People living with HIV") +
  labs(title = "a | People living with HIV") +
  theme(plot.margin = unit(c(0,0,0,0.01), "cm"))

fig3b <- fig3(variable = "Household contacts")  +
  labs(title = "b | Household contacts") +
   theme(plot.margin = unit(c(0,0.01,0,0), "cm"))

fig3c <- fig3(variable = "Other people at risk") +
  labs(title = "c | Other people at risk") +
    theme(plot.margin = unit(c(0,0.01,0,0), "cm")) 

fig.3 <- ggarrange(fig3a, fig3b, fig3c,
                           common.legend = TRUE, 
                           legend = "right",   
                           ncol = 1)
fig.3
ggsave("../results/fig3.png", plot = fig.3, width = 12, height = 16, units = "cm", dpi = 300)
```

# Figure 4

Numbers of newly initiated TPT and newly intitated ART in a subset of sites, 2018-2022 (data from COVID-TB survey, MR214).

-   Nicolas will provide the figure

# Figure 5

Available treatment options of TPT regimens.


```{r include=FALSE}
code_trt <- function(adult_col, child_col, none_col, unknown_col) {
  case_when(
    adult_col == 1 & child_col == 1 ~ "Adults & Children",
    adult_col == 1 ~ "Adults",
    child_col == 1 ~ "Children",
    none_col == 1 ~ "Not offered",
    unknown_col == 1 ~ "Don't know",
    TRUE ~ "Not offered" # the 6 that have a missing value do not provide tpt services, thus "None"
  )
}

df5 <- df %>% 
  select(record_id, inh6_b___1:other_specify_b___3, region, HBC_ANY, HBC_TB,
    HBC_TB_HIV, HBC_DR_TB, tbhiv_integration.factor, Income_group, Prev_cat.factor, ltbi_ligibility.factor) %>% 
  mutate(
         record_id = as.character(record_id),
         '6-month isoniazid (6H)' = 
           code_trt(inh6_b___1, inh6_b___2, inh6_b___77, inh6_b___3),
         '9-month isoniazid (9H)' = 
           code_trt(inh9_b___1, inh9_b___2, inh9_b___77, inh9_b___3),
         '12-month isoniazid (12H)' = 
           code_trt(inh12_b___1, inh12_b___2, inh12_b___77, inh12_b___3),
         '36/Lifetime isoniazid (36/Lifetime H)' = 
           code_trt(inh36_b___1, inh36_b___2, inh36_b___77, inh36_b___3),
         '3-month rifampicin (3R)' = 
           code_trt(rif3_b___1, rif3_b___2, rif3_b___77, rif3_b___3),
         '4-month rifampicin (4R)' = 
           code_trt(rif4_b___1, rif4_b___2, rif4_b___77, rif4_b___3),
         '3-month isoniazid-rifampicin (3HR)' = 
           code_trt(inh_rif3_b___1, inh_rif3_b___2, inh_rif3_b___77, inh_rif3_b___3),
         '4-month isoniazid-rifampicin (4HR)' = 
           code_trt(inh_rif4_b___1, inh_rif4_b___2, inh_rif4_b___77, inh_rif4_b___3),
         'Once-weekly isoniazid-rifapentine for 12 weeks (3HP)' = 
           code_trt(hp3_12weeks_b___1, hp3_12weeks_b___2, hp3_12weeks_b___77, hp3_12weeks_b___3),
         'Once-daily isoniazid-rifapentine for 1 month (1HP)' = 
           code_trt(hp3_1month_b___1, hp3_1month_b___2, hp3_1month_b___77, hp3_1month_b___3),
         'Regimens for MDR-TB exposure' = 
           code_trt(mdrtb_specify_b___1, mdrtb_specify_b___2, mdrtb_specify_b___77,
                    mdrtb_specify_b___3),
         Other = 
           code_trt(other_specify_b___1, other_specify_b___2, other_specify_b___77,
                    other_specify_b___3)) %>% 
  select(record_id, '6-month isoniazid (6H)':Other, region, HBC_ANY, HBC_TB,
    HBC_TB_HIV, HBC_DR_TB, tbhiv_integration.factor, Income_group, Prev_cat.factor, ltbi_ligibility.factor)  %>% 
  rename('Level of integration' = tbhiv_integration.factor,
         'Income Level' = Income_group, 
         'HIV Prevalence' = Prev_cat.factor,
         'LTBI testing' = ltbi_ligibility.factor) 

df5$`Level of integration` <- factor(df5$`Level of integration`,
                                     levels = c("No", "Partial", "Full"))

df5$`HIV Prevalence` <- factor(df5$`HIV Prevalence`, 
                               levels = c("Low (<1%)", "Middle (1-5%)", "High (>5%)")) 

df5$`LTBI testing` <- relevel(df5$`LTBI testing`, ref = "No")

df5b <- df5 %>% 
  pivot_longer(
    cols = 
      -c(record_id, region, HBC_ANY, HBC_TB, HBC_TB_HIV, HBC_DR_TB, `Level of integration`, 
         `Income Level`, `HIV Prevalence`, `LTBI testing`),
    names_to = "variable",
    values_to = "category") %>% 
  mutate(variable = fct(variable),
         Regimen = case_when(variable %in% c("6-month isoniazid (6H)",
                                                        "9-month isoniazid (9H)",
                                                        "12-month isoniazid (12H)",
                                                        "36/Lifetime isoniazid (36/Lifetime H)") ~ "INH-only based",
                                        variable %in% c("3-month rifampicin (3R)",
                                                        "4-month rifampicin (4R)",
                                                        "3-month isoniazid-rifampicin (3HR)",
                                                        "4-month isoniazid-rifampicin (4HR)",
                                                        "Once-weekly isoniazid-rifapentine for 12 weeks (3HP)",
                                                        "Once-daily isoniazid-rifapentine for 1 month (1HP)") ~ "RIF-based",
                                        TRUE ~ "Others"),
         Regimen = fct(Regimen, levels = c("INH-only based", "RIF-based", "Others")))

df5b <- df5b %>%
  group_by(variable, category) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(total = sum(count), 
         prop = count / total) %>%
  ungroup() %>%
  filter(category %in% c("Adults & Children", "Children", "Adults")) %>%
  group_by(variable) %>%
  summarise(prop_sum = sum(prop), .groups = "drop") %>%
  right_join(df5b, by = "variable") %>%
  mutate(variable = fct_reorder(variable, prop_sum))

saveRDS(df5b, "../data_clean/df5.rds")
```

### Top 5 (Figure for the Manuscript)

```{r}
df5_top5 <- df5 %>%
  select(`6-month isoniazid (6H)` : `Once-weekly isoniazid-rifapentine for 12 weeks (3HP)`) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Response") %>%
  group_by(Variable, Response) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(Proportion = Count / sum(Count)) %>%
  ungroup() %>%
  # Adding calculation for good responses
  group_by(Variable) %>%
  summarise(
    Prop_yes = sum(Proportion[Response %in% c("Adults & Children", "Adults", "Children")]),
    .groups = 'drop'
  ) %>%
  arrange(desc(Prop_yes)) %>% 
  slice_head(n = 5) 

ordered_vars <- rev(df5_top5$Variable)

lvl <- c("Don't know", "Not offered", "Children", "Adults", "Adults & Children")
lvl_rev <- c("Adults & Children", "Adults", "Children", "Not offered", "Don't know")

custom_colors <- c("Adults & Children" = "#8ac0ff",  
                     "Adults" = "#abe1ff",  
                     "Children" = "#d0f2ff",  
                     "Not offered" = "#fde9d8",  
                     "Don't know" = "#d3d3d3")

df5 %>%
  select(`6-month isoniazid (6H)` : `Once-weekly isoniazid-rifapentine for 12 weeks (3HP)`) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Response") %>% 
  filter(Variable %in% ordered_vars) %>% 
  mutate(Variable = factor(Variable, levels = ordered_vars),
         Variable = fct_recode(Variable, 
                          "Once-weekly isoniazid-rifapentine\nfor 12 weeks (3HP)" = "Once-weekly isoniazid-rifapentine for 12 weeks (3HP)")) %>%
   ggplot(aes(y = Variable, 
               fill = factor(Response, levels = lvl, exclude = NULL))) +
    geom_bar(position = "fill") +
      labs(
      title = "", 
      y = "", 
      x = "Proportion of clinics (%)") +
    theme_minimal() +
    theme(
      axis.text.y = element_text(hjust = 1, size = 8),
      legend.position = "bottom",
      legend.key.size = unit(0.3, "cm"), plot.margin = unit(c(0,0.5,0,0), "cm")) +
    scale_fill_manual(
      values = custom_colors,
      breaks = lvl_rev,
      name = NULL) +
    scale_x_continuous(
      expand = c(0,0), 
      labels = function(x) paste0(format(x * 100, digits = 2)),
      breaks = c(0, 0.25, 0.5, 0.75,  1))+
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "white")
```


```{r}
fig.5 <- fig5("")
fig.5
ggsave("../results/fig5.png", plot = fig.5, width = 16, height = 12, units = "cm", dpi = 300)
```

### Stratified by high burden countries

```{r}
fig5("HBC")
```

### Stratified by high burden countries (any vs. no)

```{r}
fig5("HBC_ANY")
```

### Stratified by region

```{r}
fig5("region")
```

### Stratified by level of integration

```{r}
fig5("Level of integration")
```

### Stratified by Income Level

```{r}
fig5("Income Level")
```

### Stratified by HIV Prevalence

```{r, warning=FALSE}
fig5("HIV Prevalence")
```

### Stratified by LTBI testing to check eligiblity for TPT for PLHIV

```{r}
fig5("LTBI testing")
```

### Supplementary table

I can change the order of the table for the final version (as proposed by Lukas) i.e. categories as columns. I omitted this for the moment because this option here is easier to code.

```{r}
df5 %>% 
  tbl_summary(by = HBC_ANY,
              include = c(`6-month isoniazid (6H)`,
                          `9-month isoniazid (9H)`,
                          `12-month isoniazid (12H)`,
                          `36/Lifetime isoniazid (36/Lifetime H)`,
                          `3-month rifampicin (3R)`,
                          `4-month rifampicin (4R)`,
                          `3-month isoniazid-rifampicin (3HR)`,
                          `Once-weekly isoniazid-rifapentine for 12 weeks (3HP)`,
                          `Once-daily isoniazid-rifapentine for 1 month (1HP)`,
                          `Regimens for MDR-TB exposure`,
                          Other)) %>% 
  modify_header(all_stat_cols() ~"**{level}**<br>N = {n}") 
```

### Analysis: Associations with RIF-based regimen

Every site is included. The outcome 'RIF' is defined as 1, if this site offers any RIF-based treatment and as 0 if not.

```{r}
df5_model <- df5 %>%
  mutate(
         RIF = as.integer(if_any(c("3-month rifampicin (3R)",
                                                        "4-month rifampicin (4R)",
                                                        "3-month isoniazid-rifampicin (3HR)",
                                                        "4-month isoniazid-rifampicin (4HR)",
                                                        "Once-weekly isoniazid-rifapentine for 12 weeks (3HP)",
                                                        "Once-daily isoniazid-rifapentine for 1 month (1HP)"), ~ .x %in% c("Adults", "Children", "Adults & Children"))),
         INH = as.integer(if_any(c("6-month isoniazid (6H)",
                                                        "9-month isoniazid (9H)",
                                                        "12-month isoniazid (12H)",
                                                        "36/Lifetime isoniazid (36/Lifetime H)"), ~ .x %in% c("Adults", "Children", "Adults & Children"))))

df5_model$`Income Level` <- droplevels(df5_model$`Income Level`)

df5_model$HBC_ANY <- factor(df5_model$HBC_ANY, 
                            levels = c("HBC", "Not HBC"),  # current levels
                            labels = c("Yes", "No"))       # new labels

df5_model$HBC_ANY <- relevel(df5_model$HBC_ANY, ref = "No")

df5_model %>% 
  tbl_summary(include = c(
                          region, HBC_ANY, `Level of integration`, `Income Level`, `HIV Prevalence`, `LTBI testing`), 
              digits = list(everything() ~ c(0)))   
```

#### Univariable

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_journal(journal="jama")

df5_model %>%
    tbl_uvregression(include = c(region, HBC_ANY, `Level of integration`, `Income Level`, `HIV Prevalence`, `LTBI testing`), 
      method = glm,
      y = RIF,
      method.args = list(family = binomial(link = "logit"), method = "brglmFit"),
      pvalue_fun = ~ifelse(. < 0.01, "<0.01", style_sigfig(., digits = 2)),
      exponentiate = TRUE,
      hide_n = TRUE, add_estimate_to_reference_rows = TRUE, label = list(region ~ "Region",
                                                                         HBC_ANY ~ "High burden country")) %>% 
    modify_table_body(
      ~mutate(.x, ci = ifelse(reference_row == TRUE, "Reference", ci))) %>% 
  add_global_p()|>
  as_gt() |>
  gt::gtsave(filename = "../results/tbl_rif.docx")
```

#### Multivariable 

```{r warning=FALSE, message=FALSE}
theme_gtsummary_journal(journal="jama")
glm(RIF ~ region + HBC_ANY + `Level of integration` + `Income Level` + `HIV Prevalence` + `LTBI testing`, family = binomial(), method =  "brglmFit", data = df5_model) %>% 
    tbl_regression(exponentiate = TRUE, 
                   pvalue_fun = ~style_sigfig(., digits = 2), add_estimate_to_reference_rows = TRUE) %>%  
    bold_labels() %>% 
    modify_table_body(
      ~mutate(.x, ci = ifelse(reference_row == TRUE, "Reference", ci))) %>% 
  add_global_p()
```

### Panel

```{r, fig.height=15, fig.width=11, message=F, warning=F}
fig5a <- fig5("HBC_ANY") + 
  theme(strip.text.y.right = element_blank(), 
        axis.title.x.bottom = element_blank()) +
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1)) +
labs(title = "a | Stratified by high TB burden countries")

fig5b <- fig5("region") + 
  theme(axis.text.y = element_blank(), 
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1))+
  labs(title = "b | Stratified by region")

fig5c <- fig5("Income Level") + 
  theme(strip.text.y.right = element_blank(), 
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
      labels = function(x) paste0(format(x * 100, digits = 2), "%"),
      breaks = c(0, 1))+
  labs(title = "c | Stratified by Income Level")

fig5d <- fig5("HIV Prevalence") + 
  theme(axis.text.y = element_blank(), 
        axis.title.x.bottom = element_blank()) +  scale_x_continuous(
          labels = function(x) paste0(format(x * 100, digits = 2), "%"),
          breaks = c(0, 1))+
  labs(title = "d | Stratified by HIV Prevalence")

fig5e <- fig5("Level of integration") + 
  theme(strip.text.y.right = element_blank(), 
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1))+
  labs(title = "e | Stratified by Level of Integration")

fig5f <- fig5("LTBI testing") + 
  theme(axis.text.y = element_blank(), 
        axis.title.x.bottom = element_blank()) +  
  scale_x_continuous(
    labels = function(x) paste0(format(x * 100, digits = 2), "%"),
    breaks = c(0, 1))+
  labs(title = "f | Stratified by LTBI testing")

fig.5 <- ggarrange(fig5a, fig5b, fig5c, fig5d, fig5e, fig5f,
                 common.legend = TRUE, 
                 ncol = 2, nrow = 3,
                 legend = "bottom", 
                 widths = c(1.5, 1))
fig.5
```

# Table 1

```{r}
theme_gtsummary_journal(journal="jama")

df6 <- df %>% 
  select(record_id, region, HBC_ANY, adultped.factor, rural.factor, level.factor, tbhiv_integration.factor)  %>% 
  rename(`Population the center serves` = adultped.factor,
         `Facility location` = rural.factor,
         `Facility level of care`  = level.factor,
         `Level of integrated TB/HIV services` = tbhiv_integration.factor) %>% 
    mutate(`Facility level of care` = fct_drop(`Facility level of care`),
           `Facility location` = fct_drop(`Facility location`)) %>% 
  mutate(across(.cols = everything(), .fns = ~fct_na_value_to_level(., "Missing")))

df6$HBC_ANY <- droplevels(df6$HBC_ANY)
df6$region <- droplevels(df6$region)

df6$`Level of integrated TB/HIV services` <- factor(df6$`Level of integrated TB/HIV services`,
                                     levels = c("Full", "Partial", "No", "Missing"))

levels(df6$`Facility level of care`) <- c("Health centre", "District hospital", "Regional or provincial hospital", "Missing")

df6$`Level of integrated TB/HIV services` <- fct_drop(df6$`Level of integrated TB/HIV services`, only = "Other")

levels(df6$`Population the center serves`) <- c("Adults", "Children", "Adults & Children", "Missing")

tbl1_overall <- df6 %>% 
  tbl_summary(
              include = c(
                          `Population the center serves`, 
                          `Facility location`, 
                          `Facility level of care`, 
                          `Level of integrated TB/HIV services`),
              digits = list(everything() ~ c(0))) %>%  
  modify_header(all_stat_cols(FALSE) ~ "N = {n}") 

tbl1B <- df6 %>% 
  tbl_summary(by = region,
              include = c(
                          `Population the center serves`, 
                          `Facility location`, 
                          `Facility level of care`, 
                          `Level of integrated TB/HIV services`), 
              digits = list(everything() ~ c(0))) %>% 
   modify_header(all_stat_cols(FALSE) ~ "**{level}**<br>N = {n}")

tbl_merge(
  tbls = list(tbl1_overall, tbl1B),
  tab_spanner = c("Overall", "Region")) |>
  as_gt() |> 
  gt::gtsave(filename = "../results/tbl1.docx")


```

# Table 2

```{r}
theme_gtsummary_journal(journal="jama")

df_ltbi_testing <- df %>% 
  select(record_id, ltbi_testing___0, ltbi_testing___1, ltbi_testing___2, ltbi_testing___88, ltbi_testing_oth,ltbi_ligibility.factor)  %>% 
  mutate(`Ltbi testing` = case_when(ltbi_testing___0 == 1 ~ "None",
                                    ltbi_testing___1 == 1 & ltbi_testing___2 == 1 ~ "Both",
                                    ltbi_testing___1 == 1 ~ "Interferon-Gamma Release Assays blood test",
                                    ltbi_testing___2 == 1 ~ "Tuberculin Skin Test",
                                    ltbi_testing_oth != "" ~ "Other",
                                    TRUE ~ NA)) %>% 
  select(record_id, `Ltbi testing`)

df7 <- df %>% 
  select(record_id, region, HBC_ANY, tb_symptom_screen.factor, screen_cough.factor, screen_fever.factor, screen_nightsweats.factor, screen_weightloss.factor, screen_contact.factor, screen_fatigue.factor, screen_oth.factor, ltbi_ligibility.factor, tpt_training.factor) %>% 
  left_join(df_ltbi_testing, by = "record_id") %>% 
  rename(`TB symptom screening` = tb_symptom_screen.factor,
         `Cough` = screen_cough.factor,
         `Fever`  = screen_fever.factor,
         `Night sweats` = screen_nightsweats.factor,
         `Weight loss` = screen_weightloss.factor,
         `Contact with TB patient` = screen_contact.factor,
         `Fatigue/lethargy` = screen_fatigue.factor,
         Other = screen_oth.factor,
         `LTBI testing to check eligibility of PLHIV to receive TPT`= ltbi_ligibility.factor,
         `Anyone attended a formal training on TPT provision` = tpt_training.factor,
         `Which LTBI testing is offered?` = `Ltbi testing`)  %>% 
  mutate(across(.cols = everything(), .fns = ~fct_na_value_to_level(., "Missing")),
         across(`Cough`:Other, .fns = ~fct_recode(., `Don't know` = "Dont Know")),
         `LTBI testing to check eligibility of PLHIV to receive TPT` =
           case_when(`LTBI testing to check eligibility of PLHIV to receive TPT` == "Yes" & `Which LTBI testing is offered?`!= "None" ~ `Which LTBI testing is offered?`,
                     `LTBI testing to check eligibility of PLHIV to receive TPT` == "No" ~ "No",
                     TRUE ~ "No"))

# TB screening
df7$`TB symptom screening` <- factor(df7$`TB symptom screening`, levels = c("Yes, at every appointment", "Yes, at the time of enrollment into HIV care at this facility only","Other, specify: {tb_symptom_screen_oth}", "Missing"), labels = c("Yes, at every appointment", "Yes, at the time of enrollment only","Other", "Missing"))
df7$`TB symptom screening` <- droplevels(df7$`TB symptom screening`)

# tpt training
df7$`Anyone attended a formal training on TPT provision` <- droplevels(df7$`Anyone attended a formal training on TPT provision`)

# ltbi testing
tabyl(df7$`LTBI testing to check eligibility of PLHIV to receive TPT`)
df7$`LTBI testing to check eligibility of PLHIV to receive TPT` <- factor(df7$`LTBI testing to check eligibility of PLHIV to receive TPT`, levels = c("Interferon-Gamma Release Assays blood test","Tuberculin Skin Test", "Both", "Other", "No"))

df7$`LTBI testing to check eligibility of PLHIV to receive TPT` <- droplevels(df7$`LTBI testing to check eligibility of PLHIV to receive TPT`)

df7$region <- droplevels(df7$region)

df7$`Which LTBI testing is offered?` <- factor(df7$`Which LTBI testing is offered?`, levels = c("Tuberculin Skin Test", "Interferon-Gamma Release Assays blood test", "Both",  "Other", "None" ,"Missing" ))
tabyl(df$tb_symptom_screen_oth)

df7$`Which LTBI testing is offered?` <- droplevels(df7$`Which LTBI testing is offered?`)

### Base table without screening ###

tbl2_overall <- df7 %>% 
  tbl_summary(
              include = c(`TB symptom screening`, 
                          `Anyone attended a formal training on TPT provision`,
                          `LTBI testing to check eligibility of PLHIV to receive TPT`),
              digits = list(everything() ~ c(0))) %>% 
  modify_header(stat_0 ~ "N = {n}")

tbl2B <- df7 %>% 
  tbl_summary(by = region,
              include = c(`TB symptom screening`, 
                          `Anyone attended a formal training on TPT provision`,
                          `LTBI testing to check eligibility of PLHIV to receive TPT`),
              digits = list(everything() ~ c(0))) %>% 
  modify_header(all_stat_cols(FALSE) ~ "**{level}**<br>N = {n}")

tbl2a <- tbl_merge(
  tbls = list(tbl2_overall,tbl2B),
  tab_spanner = c("Overall", "Region"))|>
  as_gt() |>
  gt::gtsave(filename = "../results/tbl2.docx")


#modify_spanning_header(tab_spanner = c("Overall", "High burden country", "Region"))


### Table for Screening ###

# Overall
# ov <- df7 %>% 
#   select(record_id,`Cough`:Other) %>% 
#   pivot_longer(cols = -c(record_id), names_to = "TB symptom screening") %>% 
#   select(-record_id) %>% 
#   mutate(stage = factor(`TB symptom screening`, levels = c("Contact with TB patient", "Cough", "Fatigue/lethargy", "Fever", "Night sweats", "Weight loss", "Other"))) %>%
#   tbl_summary(by = value, percent = "row") %>% 
#   modify_header(stat_1 ~ "N = {nrow(df7)}") %>% 
#   modify_column_hide(c(stat_2, stat_3, stat_4)) 
# ov
# # Region Africa
# 
# reg_af <- df7 %>% 
#   select(record_id, region , `Cough`:Other ) %>% 
#   filter(region == "Africa") %>% 
#   pivot_longer(cols = -c(record_id, region), names_to = "TB symptom screening") %>% 
#   select(-record_id, -region) %>% 
#   tbl_summary(by = value, percent = "row") %>% 
#   modify_header(stat_1 ~ "**Africa**<br>N = {nrow(df7 %>% filter(region == 'Africa'))}") %>% 
#   modify_column_hide(c(stat_2, stat_3, stat_4))
# 
# # Asia-Pacific
# 
# reg_as <- df7 %>% 
#   select(record_id, region , `Cough`:Other ) %>% 
#   filter(region == "Asia-Pacific") %>% 
#   pivot_longer(cols = -c(record_id, region), names_to = "TB symptom screening") %>% 
#   select(-record_id, -region) %>% 
#   tbl_summary(by = value, percent = "row") %>% 
#   modify_header(stat_1 ~ "**Asia-Pacific**<br>N = {nrow(df7 %>% filter(region == 'Asia-Pacific'))}") %>% 
#   modify_column_hide(c(stat_2, stat_3, stat_4))
# 
# # Latin America
# reg_lat <- df7 %>% 
#   select(record_id, region , `Cough`:Other ) %>% 
#   filter(region == "Latin America") %>% 
#   pivot_longer(cols = -c(record_id, region), names_to = "TB symptom screening") %>% 
#   select(-record_id, -region) %>% 
#   tbl_summary(by = value, percent = "row") %>% 
#   modify_header(stat_1 ~ "**Latin America**<br>N = {nrow(df7 %>% filter(region == 'Latin America'))}") %>% 
#   modify_column_hide(c(stat_2, stat_3, stat_4))
# 
# tbl2b <- tbl_merge(
#   tbls = list(ov, reg_af, reg_as, reg_lat),
#   tab_spanner = c("Overall",  "Region", "Region", "Region")) 
# 
# #' in order for tbl_stack to work, they have to have the same internal structure
# #' issue was, that the colnames were fine, but the tables were structured differently 
# #show_header_names(tbl2b)
# #show_header_names(tbl2a)
# #tbl2a: OV: sta01, reg: sta12,22,32
# 
# tbl2b$table_body <- tbl2b$table_body %>%
#   select(-stat_3_2, -stat_2_2) %>% 
#   rename(stat_0_1 = stat_1_1,
#          stat_1_2 = stat_1_2,
#          stat_2_2 = stat_1_3,
#          stat_3_2 = stat_1_4)
# 
# tbl_stack(tbls = list(tbl2a, tbl2b), quiet = T) |>
#   as_gt() |> 
#   gt::gtsave(filename = "../results/tbl2.docx")
```

Check if we really can combine Table 2 as suggested: 

```{r, include=FALSE}
check <- df7 %>% 
  select(record_id, `LTBI testing to check eligibility of PLHIV to receive TPT`, `Which LTBI testing is offered?`) 

check$`LTBI testing to check eligibility of PLHIV to receive TPT` <- droplevels(check$`LTBI testing to check eligibility of PLHIV to receive TPT`)
check$`Which LTBI testing is offered?` <- droplevels(check$`Which LTBI testing is offered?`)
check$`Which LTBI testing is offered?` <- factor(check$`Which LTBI testing is offered?`, levels = c("Both", "Interferon-Gamma Release Assays (IGRAs) blood test","Tuberculin Skin Test (TST)", "Other", "None"))

check %>% tbl_summary(by = `LTBI testing to check eligibility of PLHIV to receive TPT`, include = `Which LTBI testing is offered?`) 

check2 <- df %>% select(record_id, region, name, ltbi_testing___0, ltbi_ligibility.factor, tbhiv_integration.factor) %>% 
  filter(ltbi_testing___0 == 1,
         ltbi_ligibility.factor == "Yes")

check2
```

# Table 3

-   We compare the odds ratios for adherence to any of the WHO recommendations between different covariates. Use Figure 1 as a reference for the analysis.

    -   Outcome 1: Adherence to any of the recommendations for PLHIV (4 subgroups).

    -   Outcome 2: Adherence to any of the recommendations for Household contacts (4 subgroups).

    -   Outcome 3: Adherence to any of the recommendations for other people at risk (11 subgroups).

-   Therefore, the outcome variable is 'any_yes' (=0 if non of the WHO recommendations where adhered to, =1 if any of the WHO recommendations where adhered to).

-   The standard procedure for calculating the odds ratio fail for this dataset because **`Facility level of care:`District hospital** pefectly predicts the outcome (the whole column would be 0 for Fishers Exact test). The $\chi^2$-Test is also not applicable because of the low cell counts.

-   I use univariate firth logistic regression models, which applies a penalized likelihood approach, which adjusts the likelihood function to prevent the infinite likelihood estimates that result from complete seperation.

```{r}
df7 <- df1 %>% 
  group_by(record_id, who_group) %>% 
  dplyr::summarize(any_yes = ifelse(any(category == "Yes"), 1, 0), .groups = 'drop',
                   sum_yes = sum(category == "Yes"))   %>% 
  left_join(df %>% dplyr::select(record_id, tbhiv_integration.factor, Income_group, Prev_cat.factor, HBC_ANY, tpt_training.factor, level.factor, region, ltbi_ligibility.factor), by = "record_id") %>% 
  rename(
    'Level of integration' = tbhiv_integration.factor,
    'Income Level' = Income_group, 
    'HIV Prevalence' = Prev_cat.factor,
    'High burden country' = HBC_ANY,
    'TPT training' = tpt_training.factor,
    'Facility level of care' = level.factor,
    'Region' = region,
    'LTBI testing to determine eligibility of PLHIV to receive TPT' = ltbi_ligibility.factor) %>% 
  mutate(`Income Level` = as.factor(`Income Level`),
         `TPT training` = as.factor(case_when(`TPT training` %in% c(NA, "Dont Know") ~ NA,
                                    TRUE ~ `TPT training`)))

df7$`Level of integration` <- relevel(df7$`Level of integration`, ref = "No")
df7$`Income Level` <- relevel(df7$`Income Level`, ref = "Low")
df7$`HIV Prevalence` <- relevel(df7$`HIV Prevalence`, ref = "Low (<1%)")
df7$`TPT training` <- relevel(df7$`TPT training`, ref = "No")
df7$`TPT training` <- droplevels(df7$`TPT training`)
df7$`Facility level of care` <- relevel(df7$`Facility level of care`, ref = "Regional, provincial or university hospital")
levels(df7$`Facility level of care`) <- c("Health centre", "District hospital", "Regional or provincial hospital", "Missing")
df7$`Facility level of care` <- droplevels(df7$`Facility level of care`)
df7$Region <- relevel(df7$Region, ref = "Asia-Pacific")
df7$`LTBI testing to determine eligibility of PLHIV to receive TPT` <- relevel(df7$`LTBI testing to determine eligibility of PLHIV to receive TPT`, ref = "No")
df7$`High burden country` <- factor(df7$`High burden country`, 
                            levels = c("HBC", "Not HBC"),  # current levels
                            labels = c("Yes", "No"))       # new labels
df7$`High burden country` <- relevel(df7$`High burden country`, ref = "No")
df7$`Income Level` <- droplevels(df7$`Income Level`)

plhiv <- df7 %>% filter(who_group == "People living with HIV") %>% 
  dplyr::select(-record_id, -who_group) %>% 
  mutate(sum_yes = factor(sum_yes,ordered = T))
household <- df7 %>% filter(who_group == "Household contacts") %>% 
  dplyr::select(-record_id, -who_group) %>% 
  mutate(sum_yes = factor(sum_yes,ordered = T))
oPaR <- df7 %>% filter(who_group == "Other people at risk") %>% 
  dplyr::select(-record_id, -who_group) %>% 
  mutate(sum_yes = factor(sum_yes,ordered = T),
         sum_yes = factor(case_when(sum_yes %in% c("8","9","10","11") ~ "High",
                                    sum_yes %in% c("4","5","6", "7") ~ "Medium",
                                    sum_yes %in% c("1","2","3") ~ "Low",
                                    sum_yes %in% c("0") ~ "No"), ordered = T))

oPaR$sum_yes <- factor(oPaR$sum_yes, levels = c("No", "Low", "Medium", "High"))
```

### Multivariable

```{r message=FALSE, warning=FALSE, }
theme_gtsummary_journal(journal="jama")

fit_model_mult <- function(data) {
  glm(any_yes ~ 
        `Level of integration` + 
        `Income Level` + 
        `High burden country` + 
        `TPT training` +
        `HIV Prevalence` +
        `Facility level of care` + 
        `Region` +
        `LTBI testing to determine eligibility of PLHIV to receive TPT`, 
      data = data, 
      family = binomial(),
      method = "brglmFit") %>% 
    tbl_regression(exponentiate = TRUE, 
                   pvalue_fun = ~style_sigfig(., digits = 2), add_estimate_to_reference_rows = TRUE) %>%  
    bold_labels() %>% 
    modify_table_body(
      ~mutate(.x, ci = ifelse(reference_row == TRUE, "Reference", ci))) %>% 
    add_global_p()
}

dataset_list <- list(plhiv = plhiv %>% dplyr::select(-sum_yes), 
                     household = household %>% dplyr::select(-sum_yes), 
                     oPaR = oPaR %>% dplyr::select(-sum_yes))

tbls <- lapply(dataset_list, fit_model_mult) 

tbl3multi <- tbl_merge(
  tbls = tbls,
  tab_spanner = c("People living with HIV", "Household contacts", "Other people at risk"))

tbl_merge(
  tbls = tbls,
  tab_spanner = c("People living with HIV", "Household contacts", "Other people at risk"))
```

### Univariable

```{r, warning=FALSE, message=FALSE}
theme_gtsummary_journal(journal="jama")

fit_model_uni <- function(data) {
  data %>%
    tbl_uvregression(
      method = glm,
      y = any_yes,
      method.args = list(family = binomial(link= "logit"), method = "brglmFit"),
      pvalue_fun = ~ifelse(. < 0.01, "<0.01", style_sigfig(., digits = 2)),
      exponentiate = TRUE,
      hide_n = TRUE, add_estimate_to_reference_rows = TRUE
    ) %>% 
    modify_table_body(
      ~mutate(.x, ci = ifelse(reference_row == TRUE, "Reference", ci))
    ) %>% 
    add_global_p()
}

dataset_list <- list(plhiv = plhiv %>% dplyr::select(-sum_yes), 
                     household = household %>% dplyr::select(-sum_yes), 
                     oPaR = oPaR %>% dplyr::select(-sum_yes))

tbls <- lapply(dataset_list, fit_model_uni)

tbl3uni <- tbl_merge(
  tbls = tbls,
  tab_spanner = c("People living with HIV", "Household contacts", "Other people at risk")) 

tbl_merge(
  tbls = tbls,
  tab_spanner = c("People living with HIV", "Household contacts", "Other people at risk")) 

# could use as_flextable to export the table
```

### POLR model 

Interpretation looks as follows: The odds of having a higher number of implementations for PLHIV (e.g., 1, 2, 3, 4 rather than 0 or also 3, 4 rather than 0, 1, 2 [we assume proportional odds]) are estimated to be 2.13 (OR) times higher for those from low middle income countries than for those from low income countries.

```{r}
fit_model_uni_polr <- function(data) {
  data %>%
    tbl_uvregression(
      method = polr,
      y = sum_yes, # Change to your ordinal outcome variable
      method.args = list(Hess = TRUE),
      pvalue_fun = ~ifelse(. < 0.01, "<0.01", style_sigfig(., digits = 2)),
      exponentiate = TRUE,
      hide_n = TRUE, 
      add_estimate_to_reference_rows = TRUE
    ) %>% 
    modify_table_body(
      ~mutate(.x, ci = ifelse(reference_row == TRUE, "Reference", ci))
    ) %>% 
    add_global_p()
}
# Combine datasets into a list
dataset_list <- list(plhiv = plhiv %>% dplyr::select(-any_yes),
                     household = household %>% dplyr::select(-any_yes),
                     oPaR = oPaR %>% dplyr::select(-any_yes))

# Apply the univariate model function to each dataset
tbls <- lapply(dataset_list, fit_model_uni_polr)

# Merge the tables with tab spanners
tbl3uni <- tbl_merge(
  tbls = tbls,
  tab_spanner = c("People living with HIV", "Household contacts", "Other people at risk"))

# Print the merged table
tbl3uni
table
# Optionally, export the table using as_flextable
# as_flextable(tbl3uni)
save(tbl3uni, file = "table3.html")
```

### Poisson

```{r}
plhiv %>% 
  dplyr::select(-any_yes) %>% 
  mutate(sum_yes = as.numeric(sum_yes)) %>%
  tbl_uvregression(
    y = sum_yes,
    formula = "{y} ~ {x}",
    exponentiate = TRUE,
    method = glm,
    method.args = list(family = poisson(link = log))) %>% 
  add_global_p()

```

### Binomial

In the end this is probably the model that makes the most sense. For each record_id we have the number of recommendations adhered to (sum_yes) and the number of recommendations not adhered to (sum_no). We can model this as a binomial distribution with the number of trials being the sum of the two and the number of successes being the sum_yes. 

```{r}
df7_binomial <- df1 %>% 
  mutate(Yes = ifelse(category == "Yes",1,0),
         No = ifelse(category == "No",1,0)) %>%
  group_by(record_id, who_group) %>% 
  dplyr::summarize(yes = sum(Yes),
                   no = sum(No)) %>% 
  left_join(df %>% dplyr::select(record_id, tbhiv_integration.factor, Income_group, Prev_cat.factor, HBC_ANY, tpt_training.factor, level.factor, region), by = "record_id") %>% 
  rename(
    'Level of integration' = tbhiv_integration.factor,
    'Income Level' = Income_group, 
    'HIV Prevalence' = Prev_cat.factor,
    'High burden country' = HBC_ANY,
    'TPT training' = tpt_training.factor,
    'Facility level of care' = level.factor,
    'Region' = region
    #'LTBI testing to determine eligibility of PLHIV to receive TPT' = ltbi_ligibility.factor
    ) %>% 
  mutate(`Income Level` = as.factor(`Income Level`),
         `TPT training` = as.factor(case_when(`TPT training` %in% c(NA, "Dont Know") ~ NA,
                                    TRUE ~ `TPT training`))) %>% ungroup()

df7_binomial$`Level of integration` <- relevel(df7_binomial$`Level of integration`, ref = "No")
df7_binomial$`Income Level` <- relevel(df7_binomial$`Income Level`, ref = "Low")
df7_binomial$`HIV Prevalence` <- relevel(df7_binomial$`HIV Prevalence`, ref = "Low (<1%)")
df7_binomial$`TPT training` <- relevel(df7_binomial$`TPT training`, ref = "No")
df7_binomial$`TPT training` <- droplevels(df7_binomial$`TPT training`)
df7_binomial$`Facility level of care` <- relevel(df7_binomial$`Facility level of care`, ref = "Regional, provincial or university hospital")
levels(df7_binomial$`Facility level of care`) <- c("Health centre", "District hospital", "Regional or provincial hospital", "Missing")
df7_binomial$`Facility level of care` <- droplevels(df7_binomial$`Facility level of care`)
df7_binomial$Region <- relevel(df7_binomial$Region, ref = "Asia-Pacific")
#df7_binomial$`LTBI testing to determine eligibility of PLHIV to receive TPT` <- relevel(df7_binomial$`LTBI testing to determine eligibility of PLHIV to receive TPT`, ref = "No")
df7_binomial$`High burden country` <- factor(df7_binomial$`High burden country`, 
                                             levels = c("HBC", "Not HBC"),  # current levels
                                             labels = c("Yes", "No"))       # new labels
df7_binomial$`High burden country` <- relevel(df7_binomial$`High burden country`, ref = "No")
df7_binomial$`Income Level` <- droplevels(df7_binomial$`Income Level`)

plhiv_binomial <- df7_binomial %>% filter(who_group == "People living with HIV") %>% 
  dplyr::select(-record_id, -who_group)

household_binomial <- df7_binomial %>% filter(who_group == "Household contacts") %>% 
  dplyr::select(-record_id,-who_group)

oPaR_binomial <- df7_binomial %>% filter(who_group == "Other people at risk") %>% 
  dplyr::select(-record_id, -who_group) 

plhiv_binomial %>% 
  tbl_uvregression(
      y = cbind(yes, no),
    formula = "{y} ~ {x}",
    exponentiate = TRUE,
    method = glm,
    method.args = list(family = binomial(link= "logit")),
       pvalue_fun = ~ifelse(. < 0.01, "<0.01", style_sigfig(., digits = 2)),
       hide_n = TRUE, 
       add_estimate_to_reference_rows = TRUE
     ) %>% 
  add_global_p()

fit_model_uni_binomial <- function(data) {
  data %>%
    tbl_uvregression(
      y = cbind(yes, no),
    formula = "{y} ~ {x}",
    exponentiate = TRUE,
    method = glm,
    method.args = list(family = binomial(link= "logit")),
       pvalue_fun = ~ifelse(. < 0.01, "<0.01", style_sigfig(., digits = 2)),
       hide_n = TRUE, 
       add_estimate_to_reference_rows = TRUE
     ) %>% 
     modify_table_body(
       ~mutate(.x, ci = ifelse(reference_row == TRUE, "Reference", ci))
     ) %>% 
     add_global_p()
}

# Combine datasets into a list
dataset_list_binomial <- list(plhiv_binomial,household_binomial,oPaR_binomial)

# Apply the univariate model function to each dataset
tbls_binom <- lapply(dataset_list_binomial, fit_model_uni_binomial)

# Merge the tables with tab spanners
tbl_merge(
  tbls = tbls_binom,
  tab_spanner = c("People living with HIV", "Household contacts", "Other people at risk")) |>
  as_gt() |>
  gt::gtsave(filename = "../results/tbl3_binomial.docx")


```


### Compare




```{r}
dta <- data.frame()

for (i in 1:3) {
  
  var_mult <- tbl3multi$table_body[[paste0("term_", i)]]
  est_mult <- tbl3multi$table_body[[paste0("estimate_", i)]]
  low_mult <- tbl3multi$table_body[[paste0("conf.low_", i)]]
  up_mult <- tbl3multi$table_body[[paste0("conf.high_", i)]]

  var_uni <- tbl3uni$table_body[[paste0("term_", i)]]
  est_uni <- tbl3uni$table_body[[paste0("estimate_", i)]]
  low_uni <- tbl3uni$table_body[[paste0("conf.low_", i)]]
  up_uni <- tbl3uni$table_body[[paste0("conf.high_", i)]]
  
  dta_i <- data.frame(
    var = c(var_mult, var_uni),
    est = c(est_mult, est_uni),
    low = c(low_mult, low_uni),
    upper = c(up_mult, up_uni),
    model = c(rep("multivariable", length(var_mult)),
              rep("univariable", length(var_uni))),
    type = rep(i, length(var_mult) + length(var_uni)))
  
  dta <- rbind(dta, dta_i)
}

dta <- dta %>% 
        mutate(type = case_when(type == 1 ~ "PLHIV",
                            type == 2 ~ "Household contacts",
                            type == 3 ~ "OPaR",
                            TRUE ~ NA),
           log_est = log(est)) %>% 
           filter(!is.na(var))

ggplot(dta, aes(x = var, y = log_est, color = model)) +
  geom_point() +
  facet_wrap(~model) +  
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Comparison of Regression Estimates",
         x = "Variable",
         y = "Log of Estimate",
         color = "Model Type") +
  coord_flip()+
  facet_wrap(~type, ncol = 3)

```

## Results for Manuscript

### Summary

tpt implementation per region
```{r}
readRDS("../data_clean/data_clean.rds") %>% group_by(region) %>% summarise(prop = sum(tpt_prov)/n())
```


proportion per who group

```{r}
prop1 <- df1 %>% 
  group_by(who_group, variable) %>% 
  summarize(sum = sum(category == "Yes"),
    prop = round(sum(category == "Yes") / n(),2)) %>% 
  ungroup()

prop2 <- prop1 %>% 
  group_by(who_group) %>% 
  summarize(mean_n = mean(sum),
    mean_prop = mean(prop)) %>% 
  ungroup()
  
```

```{r}
df2 %>% 
  group_by(variable) %>% 
  summarize(sum = sum(category == "Yes"),
    prop = round(sum(category == "Yes") / n(),2))
```

inh/rif
```{r}
tabyl(df5_model$RIF)
tabyl(df5_model$INH)
```

The 6-month isoniazid monotherapy TPT regimen was the most widely offered (xx, xx%), followed by the 3-month once-weekly isoniazid-rifapentine regimen (xx, xx%). 
```{r}
df5 %>% select(record_id, `6-month isoniazid (6H)`, `Once-weekly isoniazid-rifapentine for 12 weeks (3HP)`, `3-month rifampicin (3R)`) %>% 
  mutate(`6-month isoniazid (6H)` = ifelse(`6-month isoniazid (6H)` %in% c("Adults", "Adults & Children", "Children"),1,0),
         `Once-weekly isoniazid-rifapentine for 12 weeks (3HP)` = ifelse(`Once-weekly isoniazid-rifapentine for 12 weeks (3HP)` %in% c("Adults", "Adults & Children", "Children"),1,0),
         `3-month rifampicin (3R)`= ifelse(`3-month rifampicin (3R)` %in% c("Adults", "Adults & Children", "Children"),1,0)) %>% 
  summarise(sum_6H = sum(`6-month isoniazid (6H)`),
            prop_6H = round(sum_6H / nrow(df5),2),
            sum_3HP = sum(`Once-weekly isoniazid-rifapentine for 12 weeks (3HP)`),
            prop_3HP = round(sum_3HP / nrow(df5),2),
            sum_3R = sum(`3-month rifampicin (3R)`),
            prop_3R = round(sum_3R / nrow(df5),2),)

```


